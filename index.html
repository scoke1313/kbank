<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>춘핑점핑 (배경 완성 버전)</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            margin: 0; padding: 0; background-color: #333;
            font-family: 'Pretendard', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; touch-action: none; user-select: none;
        }
        #game-container {
            position: relative; width: 100%; max-width: 480px; height: 100%; max-height: 850px;
            background: #f4f4f4; /* 기본 배경색 */
            box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.7); color: white; text-align: center; z-index: 20;
        }
        .hidden { display: none !important; }
        h1 { font-size: 32px; color: #FFEF6B; text-shadow: 2px 2px 0 #333; margin-bottom: 10px; }
        .btn {
            padding: 15px 40px; font-size: 20px; font-weight: bold; color: #333;
            background-color: #FEE500; border: none; border-radius: 30px; cursor: pointer;
            box-shadow: 0 5px 0 #cdae04; margin-top: 20px;
        }
        #score-board {
            position: absolute; top: 20px; left: 20px; font-size: 20px; font-weight: bold;
            color: #333; background: rgba(255, 255, 255, 0.9); padding: 8px 16px; border-radius: 20px; z-index: 5;
        }
        .controls-layer {
            position: absolute; bottom: 30px; left: 0; width: 100%; height: 100px;
            display: flex; justify-content: space-between; padding: 0 30px;
            box-sizing: border-box; pointer-events: none; z-index: 15;
        }
        .control-btn {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.5);
            border-radius: 50%; border: 4px solid white; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; color: #333; cursor: pointer;
        }
        .control-btn.pressed { background: rgba(254, 229, 0, 0.8); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="score-board">금리: <span id="rate-display">2.0</span>%</div>
    <canvas id="gameCanvas"></canvas>

    <div class="controls-layer">
        <div class="control-btn" id="btn-left">◀</div>
        <div class="control-btn" id="btn-right">▶</div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>춘핑점핑</h1>
        <p>종이 질감 배경 테마 적용 완료!</p>
        <button class="btn" onclick="startGame()">게임 시작</button>
    </div>

    <div id="game-over-screen" class="overlay hidden">
        <div style="background: white; color: #333; padding: 30px; border-radius: 20px; width: 80%;">
            <h3>적금 만기!</h3>
            <p>최종 금리</p>
            <div style="font-size: 48px; font-weight: bold; color: #D1180B;"><span id="final-rate">0.0</span>%</div>
        </div>
        <button class="btn" onclick="resetGame()">다시 하기</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('rate-display');
    const finalScoreEl = document.getElementById('final-rate');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    // 리소스 로드
    const imgJump = new Image(); imgJump.src = 'chun_pogo1.png'; 
    const imgLand = new Image(); imgLand.src = 'chun_pogo2.png';
    const imgBgTile = new Image(); imgBgTile.src = 'bg_ingame.jpg'; 
    
    const bgImgFiles = ['bg_block_1.png', 'bg_block_2.png', 'bg_block_3.png', 'bg_block_4.png', 'bg_block_5.png'];
    const bgImages = bgImgFiles.map(src => {
        const img = new Image();
        img.src = src;
        return img;
    });

    let bgPattern = null;
    let bgScrollY = 0; // 배경 타일링용 스크롤 변수

    imgBgTile.onload = () => {
        bgPattern = ctx.createPattern(imgBgTile, 'repeat');
    };

    let animationId;
    let isGameOver = false;
    let score = 2.0;
    let platforms = [];
    let items = [];
    let particles = [];
    let bgBricks = [];

    const GRAVITY = 0.45;
    const JUMP_STRENGTH = -13; 
    const PLATFORM_WIDTH = 100;
    const PLATFORM_GAP = 90;
    const FIXED_WIDTH = 80; 

    function resize() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        if(imgBgTile.complete) bgPattern = ctx.createPattern(imgBgTile, 'repeat');
    }
    window.addEventListener('resize', resize);
    resize();

    const player = { x: 0, y: 0, vx: 0, vy: 0, direction: 1, rotation: 0, landingTimer: 0 };
    const keys = { right: false, left: false };

    // 컨트롤 로직
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    function addTouchEvents(btn, keyName) {
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[keyName] = true; btn.classList.add('pressed'); }, { passive: false });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyName] = false; btn.classList.remove('pressed'); }, { passive: false });
    }
    addTouchEvents(btnLeft, 'left'); addTouchEvents(btnRight, 'right');

    class BackgroundBrick {
        constructor(y, isInitial = false) {
            this.img = bgImages[Math.floor(Math.random() * bgImages.length)];
            this.x = Math.random() * (canvas.width - 100);
            this.y = isInitial ? Math.random() * canvas.height : y;
        }
        draw() {
            if (this.img.complete) ctx.drawImage(this.img, this.x, this.y);
        }
    }

    class Platform {
        constructor(x, y) { this.x = x; this.y = y; this.width = PLATFORM_WIDTH; this.height = 16; this.broken = false; }
        draw() {
            if (this.broken) return;
            ctx.fillStyle = '#8D6E63'; ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.fillStyle = '#9CCC65'; ctx.fillRect(this.x, this.y, this.width, 6);
        }
    }

    function init() {
        score = 2.0;
        bgScrollY = 0;
        player.x = canvas.width / 2; player.y = canvas.height - 200; player.vy = -10; 
        platforms = []; items = []; bgBricks = [];
        for(let i=0; i<6; i++) bgBricks.push(new BackgroundBrick(0, true));
        platforms.push(new Platform(canvas.width / 2 - PLATFORM_WIDTH/2, canvas.height - 50)); 
        for (let i = 0; i < 7; i++) generatePlatform(canvas.height - 150 - i * PLATFORM_GAP);
        scoreEl.innerText = score.toFixed(1);
    }

    function generatePlatform(y) {
        const x = Math.random() * (canvas.width - PLATFORM_WIDTH);
        platforms.push(new Platform(x, y));
        if (Math.random() < 0.3) bgBricks.push(new BackgroundBrick(y - 50));
    }

    function update() {
        if (isGameOver) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. 최하단 타일 배경 그리기
        if (bgPattern) {
            ctx.save();
            ctx.translate(0, bgScrollY % imgBgTile.height);
            ctx.fillStyle = bgPattern;
            // 타일이 끊기지 않도록 위아래 여유있게 채움
            ctx.fillRect(0, -imgBgTile.height, canvas.width, canvas.height + imgBgTile.height * 2);
            ctx.restore();
        }

        // 2. 중간 배경 벽돌
        bgBricks.forEach(brick => brick.draw());

        // 3. 물리 및 이동
        if (keys.left) { player.vx = -6; player.direction = -1; }
        else if (keys.right) { player.vx = 6; player.direction = 1; }
        else { player.vx *= 0.8; }
        player.x += player.vx;

        if (player.landingTimer > 0) {
            player.landingTimer--; 
            if (player.landingTimer === 0) player.vy = JUMP_STRENGTH;
        } else {
            player.vy += GRAVITY;
            player.y += player.vy;
        }

        // 4. 화면 스크롤 (타일 배경 포함)
        if (player.y < canvas.height / 2.5 && player.vy < 0) {
            let dy = -player.vy;
            player.y += dy;
            bgScrollY += dy; // 타일 배경도 함께 이동
            platforms.forEach(p => p.y += dy);
            bgBricks.forEach(b => b.y += dy);
            const highest = platforms[platforms.length - 1];
            if (highest.y > PLATFORM_GAP) generatePlatform(highest.y - PLATFORM_GAP);
        }

        // 5. 충돌 및 렌더링
        let feetY = player.y + 60; 
        if (player.landingTimer === 0 && player.vy > 0) {
            platforms.forEach(p => {
                if (!p.broken && player.x > p.x - 20 && player.x < p.x + p.width + 20 && feetY >= p.y && feetY <= p.y + 20) {
                    player.landingTimer = 8; player.y = p.y - 60; player.vy = 0;
                    if (platforms.indexOf(p) !== 0) p.broken = true;
                }
            });
        }

        platforms.forEach(p => p.draw());
        
        // 캐릭터 그리기
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.scale(-player.direction, 1);
        let curImg = player.landingTimer > 0 ? imgLand : imgJump;
        if(curImg.complete) ctx.drawImage(curImg, -FIXED_WIDTH/2, -60, FIXED_WIDTH, 120);
        ctx.restore();

        if (player.y > canvas.height + 100) {
            isGameOver = true;
            finalScoreEl.innerText = score.toFixed(1);
            gameOverScreen.classList.remove('hidden');
        } else {
            animationId = requestAnimationFrame(update);
        }
    }

    function startGame() {
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        isGameOver = false;
        init();
        update();
    }

    function resetGame() { startGame(); }
</script>
</body>
</html>
