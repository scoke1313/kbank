<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>춘식아 제발 나와라</title>
    <script src="https://unpkg.com/@rive-app/canvas@2.17.3"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-stage { 
            position: relative; 
            width: 393px; 
            height: 852px; 
            background: #FFD400; 
            overflow: hidden; 
        }
        #chunsik-node {
            position: absolute;
            width: 86px;
            height: 138px;
            z-index: 10;
            /* 초기 위치 중앙 */
            left: 50%;
            margin-left: -43px;
        }
        canvas { width: 100%; height: 100%; display: block; }
        .platform {
            position: absolute;
            width: 80px;
            height: 15px;
            background: #5c3e34;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="chunsik-node">
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
const stage = document.getElementById('game-stage');
const chunsik = document.getElementById('chunsik-node');
const canvas = document.getElementById('canvas');

const PHYSICS = {
    gravity: 0.7,
    jumpPower: -20,
    moveSpeed: 6,
    stageWidth: 393,
    stageHeight: 852
};

let posX = PHYSICS.stageWidth / 2 - 43;
let posY = 600;
let vY = 0;
let platforms = [];
let keys = {};
let riveInstance;

// 1. Rive 초기화 (에러 핸들링 추가)
function initRive() {
    try {
        riveInstance = new rive.Rive({
            src: 'kongsik_ingame_air.riv', // 파일이 HTML과 같은 폴더에 있는지 확인 필수!
            canvas: canvas,
            autoplay: true,
            stateMachines: 'State Machine 1', // 리브 파일 내부 이름과 일치해야 함
            layout: new rive.Layout({
                fit: rive.Fit.Contain,
                alignment: rive.Alignment.Center
            }),
            onLoad: () => {
                console.log("리브 로드 성공!");
                riveInstance.resizeDrawingSurfaceToCanvas();
                update(); // 로드 완료 후 루프 시작
            },
            onLoadError: (e) => {
                console.error("리브 파일 로드 실패! 경로를 확인하세요:", e);
                alert("리브 파일을 찾을 수 없습니다. 경로를 확인해주세요.");
            }
        });
    } catch (e) {
        console.error("Rive 초기화 중 오류 발생:", e);
    }
}

function createPlatforms() {
    platforms = [];
    for (let i = 0; i < 7; i++) {
        platforms.push({
            x: Math.random() * (PHYSICS.stageWidth - 80),
            y: i * 130 + 100
        });
    }
    // 초기 발판은 캐릭터 발 밑에 하나 깔아줌
    platforms.push({ x: PHYSICS.stageWidth/2 - 40, y: 700 });
}

function update() {
    vY += PHYSICS.gravity;
    posY += vY;

    // 좌우 이동 및 반전
    let currentScale = 1;
    if (keys['ArrowLeft']) {
        posX -= PHYSICS.moveSpeed;
        currentScale = -1;
    } else if (keys['ArrowRight']) {
        posX += PHYSICS.moveSpeed;
        currentScale = 1;
    }

    // 위치 업데이트 및 좌우 반전 적용
    chunsik.style.transform = `translate(${posX}px, ${posY}px) scaleX(${currentScale})`;

    // 화면 무한 횡이동
    if (posX < -43) posX = PHYSICS.stageWidth - 43;
    if (posX > PHYSICS.stageWidth - 43) posX = -43;

    // 발판 충돌 (하강 시에만)
    if (vY > 0) {
        platforms.forEach(p => {
            if (posX + 60 > p.x && posX + 20 < p.x + 80 &&
                (posY + 138) > p.y && (posY + 138) < p.y + 25) {
                vY = PHYSICS.jumpPower; 
            }
        });
    }

    // 카메라 및 무한 맵 로직
    if (posY < 400) {
        const offset = 400 - posY;
        posY = 400;
        platforms.forEach(p => {
            p.y += offset;
            if (p.y > PHYSICS.stageHeight) {
                p.y = 0;
                p.x = Math.random() * (PHYSICS.stageWidth - 80);
            }
        });
    }

    // 게임 오버 처리 (바닥으로 떨어지면 리셋)
    if (posY > PHYSICS.stageHeight) {
        posY = 600;
        vY = PHYSICS.jumpPower;
    }

    drawPlatforms();
    requestAnimationFrame(update);
}

function drawPlatforms() {
    const existing = document.querySelectorAll('.platform');
    existing.forEach(e => e.remove());
    
    platforms.forEach(p => {
        const div = document.createElement('div');
        div.className = 'platform';
        div.style.left = p.x + 'px';
        div.style.top = p.y + 'px';
        stage.appendChild(div);
    });
}

window.addEventListener('keydown', (e) => keys[e.code] = true);
window.addEventListener('keyup', (e) => keys[e.code] = false);

createPlatforms();
initRive();
</script>

</body>
</html>
