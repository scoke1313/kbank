<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 0.2초의 미학</title>
    <script src="https://unpkg.com/@rive-app/canvas@2.17.3"></script>
    <style>
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-stage { position: relative; width: 393px; height: 852px; background: #FFD400; overflow: hidden; border: 4px solid #000; }
        #chunsik-node { position: absolute; width: 86px; height: 138px; z-index: 10; pointer-events: none; }
        .rive-canvas { position: absolute; width: 100%; height: 100%; display: none; }
        .active { display: block; }
        .platform { position: absolute; width: 80px; height: 15px; background: #5c3e34; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="chunsik-node">
        <canvas id="canvas-air" class="rive-canvas active"></canvas>
        <canvas id="canvas-land" class="rive-canvas"></canvas>
    </div>
</div>

<script>
const chunsikNode = document.getElementById('chunsik-node');
const canvasAir = document.getElementById('canvas-air');
const canvasLand = document.getElementById('canvas-land');

const PHYSICS = {
    gravity: 0.8,
    jumpPower: -24,
    moveSpeed: 8,
    stageWidth: 393,
    stageHeight: 852,
    motionDuration: 12 // 0.2초 (60fps 기준 약 12프레임)
};

let posX = 150; let posY = 600; let vY = 0;
let platforms = []; let keys = {};
let riveAir, riveLand;
let motionTimer = 0; // 0.2초를 카운트할 타이머

function initRive() {
    riveAir = new rive.Rive({
        src: 'kongsik_ingame_air.riv',
        canvas: canvasAir,
        autoplay: true,
        onLoad: () => { riveAir.resizeDrawingSurfaceToCanvas(); }
    });

    riveLand = new rive.Rive({
        src: 'kongsik_ingame_land.riv',
        canvas: canvasLand,
        autoplay: true,
        onLoad: () => {
            riveLand.resizeDrawingSurfaceToCanvas();
            createPlatforms();
            requestAnimationFrame(update);
        }
    });
}

// 모션 제어 로직
function triggerJumpMotion() {
    motionTimer = PHYSICS.motionDuration; // 0.2초 타이머 시작
    canvasAir.classList.add('active');
    canvasLand.classList.remove('active');
    if (riveAir) {
        riveAir.scrub("State Machine 1", 0);
        riveAir.play();
    }
}

function update() {
    vY += PHYSICS.gravity;
    posY += vY;

    // 타이머가 작동 중이면 무조건 1번 모션 유지
    if (motionTimer > 0) {
        motionTimer--;
    } else {
        // 타이머 끝났고 내려가는 중이면 2번 모션으로 전환
        if (vY > 2) {
            canvasLand.classList.add('active');
            canvasAir.classList.remove('active');
        }
    }

    // 좌우 조작
    let scale = 1;
    if (keys['ArrowLeft']) { posX -= PHYSICS.moveSpeed; scale = -1; }
    if (keys['ArrowRight']) { posX += PHYSICS.moveSpeed; scale = 1; }

    // 발판 충돌
    if (vY > 0) {
        platforms.forEach(p => {
            if (posX + 65 > p.x && posX + 15 < p.x + 80 &&
                posY + 130 > p.y && posY + 130 < p.y + 25) {
                vY = PHYSICS.jumpPower;
                triggerJumpMotion(); // 여기서 0.2초 타이머 발동
            }
        });
    }

    // 카메라 스크롤
    if (posY < 400) {
        let diff = 400 - posY;
        posY = 400;
        platforms.forEach(p => {
            p.y += diff;
            if (p.y > PHYSICS.stageHeight) {
                p.y = 0; p.x = Math.random() * 310;
            }
        });
    }

    // 추락 리셋
    if (posY > PHYSICS.stageHeight) {
        posY = 600; vY = PHYSICS.jumpPower;
        triggerJumpMotion();
    }

    chunsikNode.style.transform = `translate(${posX}px, ${posY}px) scaleX(${scale})`;
    drawPlatforms();
    requestAnimationFrame(update);
}

function createPlatforms() {
    for (let i = 0; i < 7; i++) platforms.push({ x: Math.random() * 310, y: i * 125 + 50 });
    platforms.push({ x: 150, y: 750 });
}

function drawPlatforms() {
    const existing = document.querySelectorAll('.platform');
    existing.forEach(e => e.remove());
    platforms.forEach(p => {
        const div = document.createElement('div');
        div.className = 'platform';
        div.style.left = p.x + 'px'; div.style.top = p.y + 'px';
        document.getElementById('game-stage').appendChild(div);
    });
}

window.addEventListener('keydown', (e) => keys[e.code] = true);
window.addEventListener('keyup', (e) => keys[e.code] = false);

initRive();
</script>
</body>
</html>
