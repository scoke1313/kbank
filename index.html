<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>콩콩춘식 (빌런 넉백 강화 패치)</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { margin: 0; padding: 0; background-color: #333; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: none; user-select: none; }
        #game-container { position: relative; width: 100%; max-width: 480px; height: 100%; max-height: 850px; background: linear-gradient(to bottom, #89CFF0 0%, #E0F7FA 100%); box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.7); color: white; text-align: center; z-index: 20; }
        .hidden { display: none !important; }
        h1 { font-size: 32px; color: #FFEF6B; text-shadow: 2px 2px 0 #333; margin-bottom: 10px; }
        .btn { padding: 15px 40px; font-size: 20px; font-weight: bold; color: #333; background-color: #FEE500; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 5px 0 #cdae04; margin-top: 20px; }
        #score-board { position: absolute; top: 20px; left: 20px; font-size: 20px; font-weight: bold; color: #333; background: rgba(255, 255, 255, 0.9); padding: 8px 16px; border-radius: 20px; z-index: 5; }
        .controls-layer { position: absolute; bottom: 30px; left: 0; width: 100%; height: 100px; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; z-index: 15; }
        .control-btn { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; border: 4px solid white; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 40px; color: #333; cursor: pointer; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="score-board">금리: <span id="rate-display">2.0</span>%</div>
    <canvas id="gameCanvas"></canvas>
    <div class="controls-layer"><div class="control-btn" id="btn-left">◀</div><div class="control-btn" id="btn-right">▶</div></div>
    <div id="start-screen" class="overlay">
        <h1>콩콩춘식</h1>
        <p>쥐돌이를 피하세요! (부딪히면 넉백 주의)</p>
        <button class="btn" onclick="startGame()">게임 시작</button>
    </div>
    <div id="game-over-screen" class="overlay hidden">
        <div style="background:white; color:#333; padding:30px; border-radius:20px;">
            <h3>적금 만기!</h3><p>최종 금리</p><div style="font-size:48px; font-weight:bold; color:#D1180B;"><span id="final-rate">0.0</span>%</div>
        </div>
        <button class="btn" onclick="resetGame()">다시 하기</button>
    </div>
</div>
<script>
    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('rate-display'); const finalScoreEl = document.getElementById('final-rate');
    const startScreen = document.getElementById('start-screen'); const gameOverScreen = document.getElementById('game-over-screen');
    const btnLeft = document.getElementById('btn-left'); const btnRight = document.getElementById('btn-right');
    const imgJump = new Image(); imgJump.src = 'chun_pogo1.png'; const imgLand = new Image(); imgLand.src = 'chun_pogo2.png';
    let imagesLoaded = 0; imgJump.onload = () => imagesLoaded++; imgLand.onload = () => imagesLoaded++;

    let animationId, isGameOver = false, score = 2.0, platforms = [], items = [], particles = [], clouds = [];
    const GRAVITY = 0.45, JUMP_STRENGTH = -13, PLATFORM_WIDTH = 100, PLATFORM_GAP = 90, MOVE_SPEED = 6, FIXED_WIDTH = 80;
    const player = { x: 240, y: 700, vx: 0, vy: 0, direction: 1, rotation: 0, landingTimer: 0 };
    const keys = { right: false, left: false };

    function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
    window.addEventListener('resize', resize); resize();

    window.addEventListener('keydown', e => { if(e.code === 'ArrowRight') keys.right = true; if(e.code === 'ArrowLeft') keys.left = true; });
    window.addEventListener('keyup', e => { if(e.code === 'ArrowRight') keys.right = false; if(e.code === 'ArrowLeft') keys.left = false; });
    const addTouch = (btn, key) => {
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    };
    addTouch(btnLeft, 'left'); addTouch(btnRight, 'right');

    class Enemy { // 쥐돌이 빌런
        constructor(x, y) { this.x = x; this.y = y; this.size = 26; this.collected = false; this.angle = 0; }
        draw() {
            if (this.collected) return;
            this.angle += 0.1; const floatY = Math.sin(this.angle) * 4;
            ctx.beginPath(); ctx.arc(this.x, this.y + floatY, this.size, 0, Math.PI * 2);
            ctx.fillStyle = '#FF5252'; ctx.fill(); ctx.lineWidth = 3; ctx.strokeStyle = '#311B92'; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.font = 'bold 22px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('X', this.x, this.y + floatY);
        }
    }

    class Particle {
        constructor(x, y, color) { this.x = x; this.y = y; this.vx = (Math.random()-0.5)*8; this.vy = (Math.random()-0.5)*8; this.life = 1.0; this.color = color || '#9CCC65'; }
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.3; this.life -= 0.04; }
        draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 5, 5); ctx.globalAlpha = 1.0; }
    }

    function generatePlatform(y) {
        const x = Math.random() * (canvas.width - PLATFORM_WIDTH);
        platforms.push({ x, y, width: PLATFORM_WIDTH, height: 16, broken: false });
        if (Math.random() < 0.3) items.push(new Enemy(x + PLATFORM_WIDTH/2, y - 40));
    }

    function update() {
        if (isGameOver) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (keys.left) { player.vx = -MOVE_SPEED; player.direction = -1; } else if (keys.right) { player.vx = MOVE_SPEED; player.direction = 1; } else { player.vx *= 0.92; }
        player.x += player.vx; if (player.x < 0) player.x = canvas.width; if (player.x > canvas.width) player.x = 0;

        if (player.landingTimer > 0) { player.landingTimer--; if (player.landingTimer === 0) player.vy = JUMP_STRENGTH; }
        else { player.vy += GRAVITY; player.y += player.vy; }

        if (player.y < canvas.height / 2.5 && player.vy < 0) {
            let dy = -player.vy; player.y += dy;
            platforms.forEach(p => p.y += dy); items.forEach(i => i.y += dy); particles.forEach(p => p.y += dy);
            if (platforms[platforms.length-1].y > PLATFORM_GAP) generatePlatform(platforms[platforms.length-1].y - PLATFORM_GAP);
        }

        // 충돌 판정
        let feetY = player.y + 60;
        if (player.landingTimer === 0 && player.vy > 0) {
            platforms.forEach(p => {
                if (!p.broken && player.x > p.x-15 && player.x < p.x+p.width+15 && feetY >= p.y && feetY <= p.y+20) {
                    player.landingTimer = 8; player.y = p.y - 60; player.vy = 0;
                    if (platforms.indexOf(p) !== 0) { p.broken = true; score += 0.1; scoreEl.innerText = score.toFixed(1); }
                }
            });
        }

        // 쥐돌이 충돌 (판정 30, 넉백 강화)
        items.forEach(item => {
            if (!item.collected && Math.abs(player.x - item.x) < 30 && Math.abs(player.y - item.y) < 30) {
                item.collected = true; player.vy = 12; player.vx = (player.x < item.x) ? -18 : 18;
                for(let k=0; k<20; k++) particles.push(new Particle(item.x, item.y, '#FF5252'));
            }
        });

        platforms = platforms.filter(p => p.y < canvas.height);
        platforms.forEach(p => {
            if (p.broken) return;
            ctx.fillStyle = '#8D6E63'; ctx.fillRect(p.x, p.y, p.width, p.height);
            ctx.fillStyle = '#9CCC65'; ctx.fillRect(p.x, p.y, p.width, 6);
        });
        items.forEach(i => i.draw());
        particles = particles.filter(p => p.life > 0); particles.forEach(p => { p.update(); p.draw(); });

        ctx.save(); ctx.translate(player.x, player.y); ctx.scale(-player.direction, 1);
        let img = player.landingTimer > 0 ? imgLand : imgJump;
        if(imagesLoaded >= 2) ctx.drawImage(img, -40, -60, 80, 120);
        else { ctx.fillStyle = '#FEE500'; ctx.fillRect(-20, -30, 40, 60); }
        ctx.restore();

        if (player.y > canvas.height + 100) { isGameOver = true; finalScoreEl.innerText = score.toFixed(1); gameOverScreen.classList.remove('hidden'); }
        else animationId = requestAnimationFrame(update);
    }

    function startGame() { startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); isGameOver = false;
        score = 2.0; player.x = canvas.width/2; player.y = canvas.height-150; player.vy = -10;
        platforms = []; items = []; particles = []; generatePlatform(canvas.height-50);
        for(let i=0; i<7; i++) generatePlatform(canvas.height-150-i*90);
        update();
    }
    function resetGame() { startGame(); }
</script>
</body>
</html>
